<link rel="stylesheet" href="gloo_assets_321/gloo_style/stylesheets/style.css"/>
<link rel="stylesheet" type="text/css" href="gloo_assets_75/cardsAssets/buttons/css/reject_button.css"></link>
<link rel="stylesheet" type="text/css" href="gloo_assets_75/cardsAssets/buttons/css/accept_button.css"></link>

<!-- jQuery -->
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>


<style>
    html * {
        font-family: 'Museo Sans';
    }
    .alert-top {
        padding: 0;
        z-index: 20;
    }
    
    /* tilt-right and tilt-left are unused, but would be useful if swipe was ever implemented */
    
    .tilt-right, .throw-right, .tilt-left, .throw-left, .third, .next {
        -moz-transition: all 1.0s ease;
        /* WebKit */
        -webkit-transition: all 1.0s ease;
        /* Opera */
        -o-transition: all 1.0s ease;
        /* Standard */
        transition: all 1.0s ease;
    }
    
    .tilt-right {
        -webkit-transform: translateX(10%) rotate(5deg);
        -moz-transform: translateX(10%) rotate(5deg);
        -ms-transform: translateX(10%) rotate(5deg);
        -o-transform: translateX(10%) rotate(5deg);
        transform: translateX(10%) rotate(5deg); 
    }
    
    .throw-right {
        -webkit-transform: translateX(125%) rotate(60deg);
        -moz-transform: translateX(125%) rotate(60deg);
        -ms-transform: translateX(125%) rotate(60deg);
        -o-transform: translateX(125%) rotate(60deg);
        transform: translateX(125%) rotate(60deg);
    }
    
    .center {
        -webkit-transform: translateX(0px) rotate(0deg);
        -moz-transform: translateX(0px) rotate(0deg);
        -ms-transform: translateX(0px) rotate(0deg);
        -o-transform: translateX(0px) rotate(0deg);
        transform: translateX(0px) rotate(0deg);
    }
    
    .tilt-left {
        -webkit-transform: translateX(-10%) rotate(-5deg);
        -moz-transform: translateX(-10%) rotate(-5deg);
        -ms-transform: translateX(-10%) rotate(-5deg);
        -o-transform: translateX(-10%) rotate(-5deg);
        transform: translateX(-10%) rotate(-5deg);
    }
    .throw-left {
        -webkit-transform: translateX(-150%) rotate(-60deg);
        -moz-transform: translateX(-150%) rotate(-60deg);
        -ms-transform: translateX(-150%) rotate(-60deg);
        -o-transform: translateX(-150%) rotate(-60deg);
        transform: translateX(-150%) rotate(-60deg);
    }
    
    .fade {
        opacity: 0;
        -webkit-transition: opacity 0.3s ease-in-out;
        -moz-transition: opacity 0.3s ease-in-out;
        -o-transition: opacity 0.3s ease-in-out;
        transition: opacity 0.3s ease-in-out;
    }
    
    .fade-in {
        opacity: 0.8;
        -webkit-transition: opacity 0.2s ease-in-out;
        -moz-transition: opacity 0.2s ease-in-out;
        -o-transition: opacity 0.2s ease-in-out;
        transition: opacity 0.2s ease-in-out;
    }
    .spinner {
        display: none;
        margin: 100px auto 0;
        width: 120px;
        text-align: center;
        z-index: 25;
    }
    
    .spinner > div {
        width: 24px;
        height: 24px;
        background-color: #333;
    
        border-radius: 100%;
        display: inline-block;
        -webkit-animation: bouncedelay 1.4s infinite ease-in-out;
        animation: bouncedelay 1.4s infinite ease-in-out;
        /* Prevent first frame from flickering when animation starts */
        -webkit-animation-fill-mode: both;
        animation-fill-mode: both;
    }
    
    .spinner .bounce1 {
        -webkit-animation-delay: -0.32s;
        animation-delay: -0.32s;
    }
    
    .spinner .bounce2 {
        -webkit-animation-delay: -0.16s;
        animation-delay: -0.16s;
    }
    
    @-webkit-keyframes bouncedelay {
        0%, 80%, 100% { -webkit-transform: scale(0.0) }
        40% { -webkit-transform: scale(1.0) }
    }
    
    @keyframes bouncedelay {
        0%, 80%, 100% { 
          transform: scale(0.0);
          -webkit-transform: scale(0.0);
        } 40% { 
          transform: scale(1.0);
          -webkit-transform: scale(1.0);
        }
    }
    
    .title {
        text-align: center;
    }
    
    .cards {
        position: relative;
    }
    
    .ios {
        margin-left: 15px;
    }
    
    .android {
        margin-left: 33px;
    }
    
    #fourth {
        position: absolute;
        z-index: 1;
        padding-top: 10px;
    }
    
    .fourth {
        z-index: 1;
        padding-top: 10px;
      
    }
    
    #third {
        position: absolute;
        z-index: 2;
        padding-top: 10px;
        -webkit-transform: translate(0, -5px);
        -moz-transform: translate(0, -5px);
        -ms-transform: translate(0, -5px);
        -o-transform: translate(0, -5px);
        transform: translate(0, -5px);
    }
    
    #next_card {
        position: absolute;
        z-index: 3;
    }
    
    #current_card {
        position: absolute;
        z-index: 4;
    }
    
    #current_card, #next_card, #third, #fourth {
        width: 290px;
        height: 290px;
    }
        
    
    #accept, #reject {
        position: absolute;
        z-index: 10;
        top: 0px;
        left: 0px;
    }
    
    #not_now {
        float: left;
        width: 130px;
        height: 130px;
        margin-top: 292px;
        margin-left: 9%;
        opacity: 0.6;
    }
    
    #accept2 {
        float: right;
        margin-top: -130px;
        margin-right: 9%;
        width: 130px;
        height: 130px;
        margin-left: 45%;
        opacity: 0.6;
    }
    
    #accepted {
        width: 100%;
    }
</style>
<body>
    <div class="cards">
        <img class="fourth" id="fourth" src="gloo_assets_75/cardsAssets/images/CARD-01_small.png">
        <img class="third" id="third" src="gloo_assets_75/cardsAssets/images/CARD-01_small.png">
        <img class="next" id="next_card" src="">
        <img class="current" id="current_card" src="">
        <div class="stamps">
            <img class="fade" id="reject" src="gloo_assets_75/cardsAssets/images/button_reject_290.png">
            <img class="fade" id="accept" src="gloo_assets_75/cardsAssets/images/button_accept_290.png">
        </div>
    </div>
    <img id="not_now" src="gloo_assets_75/cardsAssets/images/button_reject_290.png">
    <img id="accept2" src="gloo_assets_75/cardsAssets/images/button_accept_290.png">
    <div class="alert-top" id="success-msg"><img id="accepted" src=""/></div>
    <div id="loading" class="spinner">
        <div class="bounce1"></div>
        <div class="bounce2"></div>
        <div class="bounce3"></div>
    </div>
    <br>

    <script>
        
        /*------------ Helper functions ------------*/
        
        var getUnacceptedChallengesArray = function () {
            return (JSON.parse(elementAPI.userData().getValue("unacceptedChallenges")));
        };
        
        var lowOnCards = function (array) {
            return array.length < 3;
        };
        
        var promptReset = function () {
            //Instead of alert, should be an .alert-top just like alertCongratulations
            alert("You're running low on new challenges.. Go back to your Challenge Checklist to complete any unfinished challenges, THEN, reshuffle your challenge cards to play again.");
            //Chromeless nav back to menu?
        };
        
        var shuffleArray = function (array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        };
        
        var isLastCard = function (array, currentIndex) {
            return ((array.length) === currentIndex);
        };
        
        var displayNextCard = function (nextChallenge) {
            $("#next_card").attr("src", nextChallenge);
            return true;
        };
        
        var displayCard = function (currentChallenge) {
            $("#current_card").attr("src", currentChallenge);
            return true;
        };
        
        var alertCongratulations = function () {
            $("#accepted").attr("src", currentAcceptImage);
            $("#success-msg").fadeIn(900);
        };
        
        var animateButton = function (id) {
            $(id).animate({
                duration: "fast",
                opacity: 1.0
            });
            setTimeout(function() {
                $(id).animate({
                    duration: "fast",
                    opacity: 0.6
                });
            }, 100);
        };
        
        var setiOSButtons = function (x, y) {
            if (x > 72 && x < 254 && y > 375 && y < 410) {
                // Keep playing
                $("#success-msg").fadeOut(600);
                setTimeout(function() {
                    $("#accepted").attr("src", "");
                    if (lowOnCards(unacceptedChallenges)) {
                        promptReset();
                    }
                }, 650);
            }
            if (x > 70 && x < 254 && y > 312 && y < 347) {
                // OK button clicked; return to menu --> doesn't work on samsung
                $("#loading").show();
                window.location.href = "gloo://app/applets/next_applet";
            }  
        };
        
        var setForAndroid = function () {
            $("#success-msg").fadeOut(800);
            setTimeout(function() {
                $("#accepted").attr("src", "");
            }, 850);
        };
        
        $(window).resize(function() {
            $('.spinner').css({
                position:'fixed',
                left: ($(window).width() - $('.spinner').outerWidth())/2
            });
        });
        
        // "Globals"
       var currentIndex = 0;
       var currentChallenge;
       var nextChallenge;
       var unacceptedChallenges;
       var currentAcceptImage;
       
        $(document).ready(function() {
            $(window).resize();
            if (navigator.userAgent.match(/Android/i)) {
                $(".cards").addClass("android");
            } else {
                $(".cards").addClass("ios");
            }
            unacceptedChallenges = shuffleArray(getUnacceptedChallengesArray());
            
//            if (lowOnCards(unacceptedChallenges)) {
//                promptReset();
//            } else {
                currentChallenge = unacceptedChallenges[currentIndex];
                nextChallenge = unacceptedChallenges[currentIndex + 1];
                displayCard(currentChallenge.card.image);
                displayNextCard(nextChallenge.card.image);
//            }
        });
        
        
        $("#not_now").click(function() {
            animateButton("#not_now");
            $("#reject").addClass("fade-in");
            $("#current_card").removeClass("center");
            setTimeout(function() {
                $("#reject").removeClass("fade-in");
                $("#current_card").addClass("throw-left");
            }, 500);
            setTimeout(function() {
                $("#current_card").attr("src", nextChallenge.card.image);
                $("#current_card").removeClass("throw-right");
                $("#current_card").removeClass("throw-left");
                currentIndex++;
                if (isLastCard(unacceptedChallenges, currentIndex + 1)) {
                    console.log("Nearing the end of the deck");
                    currentChallenge = nextChallenge;
                    currentIndex = -1;
                    unacceptedChallenges = getUnacceptedChallengesArray();
                    shuffleArray(unacceptedChallenges);
                    console.log("Current card: " + currentChallenge.card.title);
                    nextChallenge = unacceptedChallenges[currentIndex + 1];
                    // Check if the current card just came up
                    while (nextChallenge.card.title === currentChallenge.card.title) {
                        unacceptedChallenges = shuffleArray(unacceptedChallenges);
                        nextChallenge = unacceptedChallenges[currentIndex + 1];
                    }
                } else {
                    currentChallenge = unacceptedChallenges[currentIndex];
                    nextChallenge = unacceptedChallenges[currentIndex + 1];
                    // Check if the current card just came up
                    while (nextChallenge.card.title === currentChallenge.card.title) {
                        unacceptedChallenges = shuffleArray(unacceptedChallenges);
                        nextChallenge = unacceptedChallenges[currentIndex + 1];
                    }
                }
                displayNextCard(nextChallenge.card.image);
                $("#current_card").addClass("center");
            }, 1050);
        });
            
        $("#accept2").click(function() {
            animateButton("#accept2");
            $("#accept").addClass("fade-in");
            $("#current_card").removeClass("center");
            setTimeout(function() {
                $("#accept").removeClass("fade-in");
                $("#current_card").addClass("throw-right");
                setTimeout(function() {
                    currentAcceptImage = currentChallenge.card.acceptImage;
                    alertCongratulations();
                }, 500);  
            }, 500);
            currentChallenge.accepted = true;
            
            var acceptedChallenges = [];
            // Add to databag -- first check if it's user's first time
            if (elementAPI.userData().getValue("acceptedChallenges")) {
                acceptedChallenges = JSON.parse(elementAPI.userData().getValue("acceptedChallenges"));
            }
            
            var newChallenge = currentChallenge;
            console.log("ready for db: " + JSON.stringify(newChallenge));
            acceptedChallenges.unshift(newChallenge); // Adds element to front of array
            var stringedArray = JSON.stringify(acceptedChallenges); // stringify array for databag
            elementAPI.userData().setValue("acceptedChallenges", stringedArray); // array into databag
            for (var i = 0; i < unacceptedChallenges.length; i++) {
                if (unacceptedChallenges[i].card.title === newChallenge.card.title) {
                    unacceptedChallenges.splice(i,1);
                    break;
                }
            }
            // unacceptedChallenges is now one element shorter
            currentIndex--;
            var stringedUnaccepted = JSON.stringify(unacceptedChallenges);
            elementAPI.userData().setValue("unacceptedChallenges", stringedUnaccepted);
            setTimeout(function() {
                $("#current_card").attr("src", nextChallenge.card.image);
                $("#current_card").removeClass("throw-right");
                $("#current_card").removeClass("throw-left");
                currentIndex++;
                if (isLastCard(unacceptedChallenges, currentIndex + 1)) {
                    currentChallenge = nextChallenge;
                    currentIndex = -1;
                    unacceptedChallenges = shuffleArray(getUnacceptedChallengesArray());
                    nextChallenge = unacceptedChallenges[currentIndex + 1];
                    // Check if the current card just came up
                    while (nextChallenge.card.title === currentChallenge.card.title) {
                        unacceptedChallenges = shuffleArray(unacceptedChallenges);
                        nextChallenge = unacceptedChallenges[currentIndex + 1];
                    }
                } else {
                    currentChallenge = nextChallenge;
                    nextChallenge = unacceptedChallenges[currentIndex + 1];
                    // Check if the current card just came up
                    while (nextChallenge.card.title === currentChallenge.card.title) {
                        unacceptedChallenges = shuffleArray(unacceptedChallenges);
                        nextChallenge = unacceptedChallenges[currentIndex + 1];
                    }
                }
                displayNextCard(nextChallenge.card.image);
                $("#current_card").addClass("center");
            }, 1050);
        });
        
        $("#accepted").click(function(e) {
            var pos = $(this).position();
            //The following are the x/y coordinates of the mouse click relative to image.
            var x = e.pageX - pos.left;
            var y = e.pageY - pos.top;
            if (navigator.userAgent.match(/Android/i)) {
                setForAndroid();
            } else {
                setiOSButtons(x, y);
            }
        });
        
    </script>
</body>