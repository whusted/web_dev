<link rel="stylesheet" href="gloo_assets_321/gloo_style/stylesheets/style.css"/>

<!-- jQuery -->
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>


<style>
    .tilt-right, .throw-right, .tilt-left, .throw-left {
        -moz-transition: all .4s ease;
        /* WebKit */
        -webkit-transition: all .4s ease;
        /* Opera */
        -o-transition: all .4s ease;
        /* Standard */
        transition: all 1.0s ease;
    }
    
    .tilt-right {
        -webkit-transform: translateX(10%) rotate(5deg);
        -moz-transform: translateX(10%) rotate(5deg);
        -ms-transform: translateX(10%) rotate(5deg);
        -o-transform: translateX(10%) rotate(5deg);
        transform: translateX(10%) rotate(5deg);
        
    }
    
    .throw-right {
        -webkit-transform: translateX(125%) rotate(60deg);
        -moz-transform: translateX(125%) rotate(60deg);
        -ms-transform: translateX(125%) rotate(60deg);
        -o-transform: translateX(125%) rotate(60deg);
        transform: translateX(125%) rotate(60deg);
    }
    .center {
        -webkit-transform: translateX(0px) rotate(0deg);
        -moz-transform: translateX(0px) rotate(0deg);
        -ms-transform: translateX(0px) rotate(0deg);
        -o-transform: translateX(0px) rotate(0deg);
        transform: translateX(0px) rotate(0deg);
    }
    .tilt-left {
        -webkit-transform: translateX(-10%) rotate(-5deg);
        -moz-transform: translateX(-10%) rotate(-5deg);
        -ms-transform: translateX(-10%) rotate(-5deg);
        -o-transform: translateX(-10%) rotate(-5deg);
        transform: translateX(-10%) rotate(-5deg);
    }
    .throw-left {
        -webkit-transform: translateX(-150%) rotate(-60deg);
        -moz-transform: translateX(-150%) rotate(-60deg);
        -ms-transform: translateX(-150%) rotate(-60deg);
        -o-transform: translateX(-150%) rotate(-60deg);
        transform: translateX(-150%) rotate(-60deg);
    }
    
    .title {
        text-align: center;
    }
    
    .cards {
        position: relative;
    }
    
    #next_card {
        position: absolute;
        z-index: 1;
    }
    
    #current_card {
        position: relative;
        z-index: 2;
    }
</style>
<body>
    <div class="title">
        <h4>Take a Challenge</h4>
    </div>
    <hr>
        <div class="cards">
            <img id="next_card" src="">
            <img id="current_card" src="">
        </div>
        <button class="btn" id="not_now">Not Now</button>
        <button class="btn" id="accept">Accept</button>
   <script> 
        
        /*------------ Helper functions ------------*/
        
        var getUnacceptedChallengesArray = function () {
            return (JSON.parse(elementAPI.userData().getValue("unacceptedChallenges")));
        };
        
        var lowOnCards = function(array) {
            return array.length < 3;
        };
        
        var promptReset = function() {
            alert("You're running low on new challenges :( Go back to the Menu to complete any unfinished challenges, or reset your challenges to begin again!");
            //Chromeless nav back to menu
        };
        
        var shuffleArray = function (array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        };
        
        var isLastCard = function (array, currentIndex) {
            return ((array.length) === currentIndex);
        };
        
        var displayNextCard = function (nextChallenge) {
            $("#next_card").attr("src", nextChallenge);
            return true;
        };
        
        var displayCard = function (currentChallenge) {
            $("#current_card").attr("src", currentChallenge);
            return true;
        };
        
        
        // "Globals"
       var currentIndex = 0;
       var currentChallenge;
       var nextChallenge;
       var shuffledChallenges;
       var unacceptedChallenges;
       
        $(document).ready(function() {
            // Array of text challenges
            unacceptedChallenges = getUnacceptedChallengesArray();
            shuffledChallenges = shuffleArray(unacceptedChallenges);
            
            if (lowOnCards(unacceptedChallenges)) {
                promptReset();
            } else {
                currentChallenge = shuffledChallenges[currentIndex];
                nextChallenge = shuffledChallenges[currentIndex + 1];
                console.log(JSON.stringify(currentChallenge));
                displayNextCard(nextChallenge.card.image);
                displayCard(currentChallenge.card.image);
                console.log("Current card at start: " + currentChallenge.card.title);
            }
        });
        
        
        $("#not_now").click(function() {
            $("#current_card").addClass("throw-left");
            setTimeout(function() {
                $("#current_card").attr("src", nextChallenge.card.image);
                $("#current_card").removeClass("throw-right");
                $("#current_card").removeClass("throw-left");
                currentIndex++;
                if (isLastCard(shuffledChallenges, currentIndex + 1)) {
                    console.log("Nearing the end of the deck");
                    currentChallenge = nextChallenge;
                    currentIndex = -1;
                    shuffledChallenges = getUnacceptedChallengesArray();
                    shuffleArray(shuffledChallenges);
                    console.log("Current card: " + currentChallenge.card.title);
                    nextChallenge = shuffledChallenges[currentIndex + 1];
                    console.log("Next Card: " + nextChallenge.card.title);
                } else {
                    console.log("Not near the end");
                    currentChallenge = shuffledChallenges[currentIndex];
                    nextChallenge = shuffledChallenges[currentIndex + 1];
                    console.log("Current card: " + currentChallenge.card.title);
                    console.log("Next card: " + nextChallenge.card.title);
                }
                displayNextCard(nextChallenge.card.image);
                $("#current_card").addClass("center");
                console.log("Index at end: " + currentIndex);
            }, 800);
        });
            
        $("#accept").click(function() {
            $("#current_card").addClass("throw-right");
            console.log("Current card: " + currentChallenge.card.title);
            currentChallenge.accepted = true;
            
            var acceptedChallenges = [];
            // Add to databag -- first check if it's user's first time
            if (elementAPI.userData().getValue("acceptedChallenges")) {
                acceptedChallenges = JSON.parse(elementAPI.userData().getValue("acceptedChallenges"));
            }
            
            var newChallenge = currentChallenge;
            console.log("ready for db: " + JSON.stringify(newChallenge));
            acceptedChallenges.unshift(newChallenge); // Adds element to front of array
            var stringedArray = JSON.stringify(acceptedChallenges); // Prepare for databag
            elementAPI.userData().setValue("acceptedChallenges", stringedArray); // array into databag
            for (var i = 0; i < unacceptedChallenges.length; i++) {
                if (unacceptedChallenges[i].card.title === newChallenge.card.title) {
                    unacceptedChallenges.splice(i,1);
                    break;
                }
            }
            var stringedUnaccepted = JSON.stringify(unacceptedChallenges);
            elementAPI.userData().setValue("unacceptedChallenges", stringedUnaccepted);
            setTimeout(function() {
                $("#current_card").attr("src", nextChallenge.card.image);
                $("#current_card").removeClass("throw-right");
                $("#current_card").removeClass("throw-left");
                currentIndex++;
                if (isLastCard(shuffledChallenges, currentIndex + 1)) {
                    console.log("Nearing the end of the deck");
                    currentChallenge = nextChallenge;
                    currentIndex = -1;
                    shuffledChallenges = getUnacceptedChallengesArray();
                    shuffleArray(shuffledChallenges);
                    console.log("Current card: " + currentChallenge.card.title);
                    nextChallenge = shuffledChallenges[currentIndex + 1];
                    console.log("Next Card: " + nextChallenge.card.title);
                } else {
                    console.log("Not near the end");
                    currentChallenge = shuffledChallenges[currentIndex];
                    nextChallenge = shuffledChallenges[currentIndex + 1];
                    console.log("Current card: " + currentChallenge.card.title);
                    console.log("Next card: " + nextChallenge.card.title);
                }
                displayNextCard(nextChallenge.card.image);
                $("#current_card").addClass("center");
                console.log("Index at end: " + currentIndex);
            }, 800);
        });
        
   </script>
</body>