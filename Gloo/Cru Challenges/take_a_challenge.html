<link rel="stylesheet" href="gloo_assets_321/gloo_style/stylesheets/style.css"/>
<link rel="stylesheet" type="text/css" href="http://fancyapps.com/fancybox/source/jquery.fancybox.css"></link>

<!-- jQuery -->
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<!--- Fancybox -->
<script src="http://dev.be-pixel.com/newsletter4/js/jquery.fancybox.pack.js"></script>

<style>
    .title {
        text-align: center;
    }
    
</style>
<body>
    <div class="title">
        <h4>Take a Challenge</h4>
    </div>
    <hr>
        <!-- Below is a dummy div; replace with cards -->
        <img id="current_card" src="">
        <button class="btn" id="not_now">Not Now</button>
        <button class="btn" id="accept">Accept</button>
        <a style="text-align: center" class="fancyTrigger" href="#TheFancybox">
        <div id="TheFancybox"></div>
        
   <script> 
        
        /*------------ Helper functions ------------*/
        
        var getUnacceptedChallengesArray = function () {
            return (JSON.parse(elementAPI.userData().getValue("unacceptedChallenges")));
        };
        
        var shuffleArray = function (array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        };
        
        var lastCard = function (array, currentIndex) {
            return ((array.length) === currentIndex);
        };
        
        var displayCard = function (currentCard) {
            $("#current_card").attr("src", currentCard);
            return true;
        };
        
        
        // "Globals"
       var currentIndex = 0;
       var currentChallenge; // Not sure if this is going to work in helper functions
       var shuffledChallenges;
       var unacceptedChallenges;
       
        $(document).ready(function() {
            alert(JSON.stringify(elementAPI.userData()));
            // Array of text challenges
            unacceptedChallenges = getUnacceptedChallengesArray();
            shuffledChallenges = shuffleArray(unacceptedChallenges);
            
            for (var i = 0; i < shuffledChallenges.length; i++) {
                console.log(shuffledChallenges[i]);
            }
            // "Top" card
            currentChallenge = shuffledChallenges[currentIndex];
            console.log(JSON.stringify(currentChallenge));
            displayCard(currentChallenge.card.image);
        });
        
        
        $("#not_now").click(function() {
            currentIndex++;
                if (lastCard(shuffledChallenges, currentIndex)) {
                    currentIndex = 0;
                    shuffledChallenges = getUnacceptedChallengesArray();
                    shuffleArray(shuffledChallenges);
                    currentChallenge = shuffledChallenges[currentIndex];
                } else {
                    currentChallenge = shuffledChallenges[currentIndex];
                }
            displayCard(currentChallenge.card.image);
        });
            
        $("#accept").click(function() {
            currentChallenge.accepted = true;
            // Temp behavior -- fancybox pop up
            $("#TheFancybox").html("<p>Congratulations! This challenge has been added to your 'Current Challenges'.</p>");
            $(".fancyTrigger").fancybox();
            $(".fancyTrigger").trigger('click');
          
            // Chromeless nav -- straight to element with more info, or back to menu
            
            // Non chromeless nav -- button highlights and wait for "next" click
            
            var acceptedChallenges = [];
            // Add to databag -- first check if it's user's first time
            if (elementAPI.userData().getValue("acceptedChallenges")) {
                acceptedChallenges = JSON.parse(elementAPI.userData().getValue("acceptedChallenges"));
            }
            
            var newChallenge = currentChallenge;
            acceptedChallenges.unshift(newChallenge); // Adds element to front of array
            var stringedArray = JSON.stringify(acceptedChallenges); // Prepare for databag
            alert("ready for db: " + stringedArray);
            elementAPI.userData().setValue("acceptedChallenges", stringedArray); // array into databag
            for (var i = 0; i < unacceptedChallenges.length; i++) {
                if (unacceptedChallenges[i].card.title === newChallenge.card.title) {
                    unacceptedChallenges.splice(i,1);
                    break;
                }
            }
            var stringedUnaccepted = JSON.stringify(unacceptedChallenges);
            elementAPI.userData().setValue("unacceptedChallenges", stringedUnaccepted);
            console.log(elementAPI.userData());
            console.log(elementAPI.userData().getValue("acceptedChallenges"));
            console.log(elementAPI.userData().getValue("unacceptedChallenges"));

            currentIndex++;
            currentCard = shuffledChallenges[currentIndex];
            displayCard(currentCard);
        });
        
   </script>
</body>